{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<style>
    /* --- E-COMMERCE CARD DESIGN SYSTEM --- */
    :root {
        --card-border: #f0f0f0;
        --text-dark: #212529;
        --text-muted: #6c757d;
        --price-color: #B12704; /* The classic 'Deal' red/orange */
        --brand-green: #1B4F2D;
    }

    /* 1. HERO CAROUSEL REFINEMENTS */
    .hero-slide {
        height: 500px; /* Slightly more compact for modern screens */
        background-size: cover;
        background-position: center;
        position: relative;
    }
    .hero-overlay {
        background: linear-gradient(to right, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.3) 100%);
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        align-items: center;
    }
    .hero-content {
        max-width: 600px;
        padding-left: 5%;
        color: white;
    }

    /* 2. PRODUCT CARD (Amazon Style) */
    .product-card {
        border: 1px solid var(--card-border);
        border-radius: 8px;
        background: white;
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }

    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        border-color: #ddd;
    }

    /* Fixed Image Container - Prevents messy grids */
    .card-img-container {
        height: 220px;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #fff;
        border-bottom: 1px solid #f8f9fa;
        text-decoration: none;
    }
    
    .card-img-container img {
        max-height: 100%;
        max-width: 100%;
        object-fit: contain; 
        transition: transform 0.3s;
    }
    
    .product-card:hover .card-img-container img {
        transform: scale(1.05); /* Subtle zoom effect */
    }

    .card-body {
        padding: 15px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .product-category {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        font-weight: 600;
    }

    .product-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 8px;
        line-height: 1.4;
        /* Limit title to 2 lines like Amazon */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-decoration: none;
    }
    
    .product-title:hover {
        color: var(--brand-green);
    }

    .specs-badge {
        font-size: 0.75rem;
        background-color: #f8f9fa;
        color: #555;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #eee;
        display: inline-block;
        margin-bottom: 10px;
        margin-right: 5px;
    }

    .product-price {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--price-color);
        margin-top: auto; /* Pushes price to bottom */
        margin-bottom: 15px;
    }

    .btn-view {
        width: 100%;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 8px;
        border: 1px solid #ddd;
        background: white;
        color: #333;
        transition: all 0.2s;
        text-decoration: none;
        display: block;
        text-align: center;
    }
    .btn-view:hover {
        background-color: var(--brand-green);
        color: white;
        border-color: var(--brand-green);
    }

    /* BADGES */
    .badge-top-pick {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: #F7A800; /* Gold */
        color: black;
        font-size: 0.7rem;
        font-weight: 800;
        padding: 4px 10px;
        border-radius: 3px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
</style>

<div id="heroCarousel" class="carousel slide carousel-fade mb-5" data-bs-ride="carousel" data-bs-interval="6000">
    <div class="carousel-indicators">
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="3"></button>
    </div>

    <div class="carousel-inner">
        <div class="carousel-item active">
            <div class="hero-slide" style="background-image: url('https://images.unsplash.com/photo-1497215728101-856f4ea42174?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');">
                <div class="hero-overlay">
                    <div class="hero-content">
                        <span class="badge bg-warning text-dark mb-3">Tech Partner</span>
                        <h1 class="display-4 fw-bold mb-3">Professional Laptops for <br>Nairobi's Workforce</h1>
                        <a href="#shop" class="btn btn-success btn-lg shadow fw-bold px-4">Shop Now</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="carousel-item">
            <div class="hero-slide" style="background-image: url('https://images.unsplash.com/photo-1531297484001-80022131f5a1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');">
                <div class="hero-overlay">
                    <div class="hero-content">
                        <span class="badge bg-info text-dark mb-3">High Performance</span>
                        <h1 class="display-4 fw-bold mb-3">Power Your Business</h1>
                        <a href="{% url 'index' %}?usage=Business" class="btn btn-light btn-lg shadow fw-bold px-4">View Business Laptops</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="carousel-item">
            <div class="hero-slide" style="background-image: url('https://images.unsplash.com/photo-1573164713988-8665fc963095?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');">
                <div class="hero-overlay">
                    <div class="hero-content">
                        <span class="badge bg-success mb-3">Best Deals</span>
                        <h1 class="display-4 fw-bold mb-3">Student Specials</h1>
                        <a href="{% url 'index' %}?usage=Student" class="btn btn-warning btn-lg shadow fw-bold px-4">See Offers</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="carousel-item">
            <div class="hero-slide" style="background-image: url('https://images.unsplash.com/photo-1611186871348-b1ce696e52c9?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');">
                <div class="hero-overlay">
                    <div class="hero-content">
                        <span class="badge bg-light text-dark mb-3">Ultra Portability</span>
                        <h1 class="display-4 fw-bold mb-3">Sleek & Lightweight</h1>
                        <a href="{% url 'index' %}?type=Slim" class="btn btn-outline-light btn-lg fw-bold px-4">Browse Slim Laptops</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<section class="container mb-5">
    <div class="row text-center g-4">
        <div class="col-md-4">
            <div class="p-4 bg-white border rounded shadow-sm h-100">
                <i class="fas fa-truck fa-2x text-success mb-3"></i>
                <h6 class="fw-bold">Countrywide Delivery</h6>
                <p class="text-muted small mb-0">Secure shipping across Kenya</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="p-4 bg-white border rounded shadow-sm h-100">
                <i class="fas fa-shield-alt fa-2x text-warning mb-3"></i>
                <h6 class="fw-bold">6-Month Warranty</h6>
                <p class="text-muted small mb-0">Peace of mind guaranteed</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="p-4 bg-white border rounded shadow-sm h-100">
                <i class="fas fa-comments fa-2x text-primary mb-3"></i>
                <h6 class="fw-bold">Expert Support</h6>
                <p class="text-muted small mb-0">Talk to a real technician</p>
            </div>
        </div>
    </div>
</section>

{% if featured_products and not request.GET %}
<section class="container mb-5">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <h3 class="fw-bold mb-0" style="font-family: 'Montserrat', sans-serif;">Top Picks For You</h3>
        <a href="#shop" class="text-decoration-none small fw-bold text-success">View All <i class="fas fa-arrow-right ms-1"></i></a>
    </div>
    
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 row-cols-lg-4 g-3 justify-content-center">
        {% for item in featured_products %}
        <div class="col">
            <div class="product-card">
                <span class="badge-top-pick">TOP PICK</span>
                
                <a href="{% url 'product_detail' item.id %}" class="card-img-container">
                    {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.name }}">
                    {% else %}
                    <div class="text-muted"><i class="fas fa-camera fa-3x"></i></div>
                    {% endif %}
                </a>
                
                <div class="card-body">
                    <div class="product-category">{{ item.category.name }}</div>
                    <a href="{% url 'product_detail' item.id %}" class="product-title">
                        {{ item.name }}
                    </a>
                    
                    <div>
                        {% if item.ram %}
                        <span class="specs-badge"><i class="fas fa-memory me-1"></i>{{ item.ram }}</span>
                        {% endif %}
                    </div>

                    <div class="product-price">KES {{ item.price|intcomma }}</div>
                    
                    <a href="{% url 'product_detail' item.id %}" class="btn btn-view">View Deal</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<hr class="container my-5 opacity-10">

<section id="shop" class="container mb-5">
    <div class="row">
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-sm p-3 sticky-top" style="top: 100px; z-index: 1;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0"><i class="fas fa-filter me-2"></i>Filter Results</h6>
                    <a href="{% url 'index' %}" class="small text-danger text-decoration-none">Clear</a>
                </div>
                
                <form method="get" action=".">
                    {% if request.GET.q %}
                    <input type="hidden" name="q" value="{{ request.GET.q }}">
                    {% endif %}

                    <div class="mb-3">
                        <label class="small fw-bold text-muted mb-1">Use Case</label>
                        <select name="usage" class="form-select form-select-sm bg-light border-0">
                            <option value="">All Uses</option>
                            <option value="Student" {% if selected_usage == 'Student' %}selected{% endif %}>Student</option>
                            <option value="Gaming" {% if selected_usage == 'Gaming' %}selected{% endif %}>Gaming</option>
                            <option value="Business" {% if selected_usage == 'Business' %}selected{% endif %}>Business</option>
                            <option value="Premium" {% if selected_usage == 'Premium' %}selected{% endif %}>Premium</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold text-muted mb-1">Max Price (KES)</label>
                        <input type="number" name="max_price" class="form-control form-control-sm" placeholder="e.g. 40000" value="{{ selected_max_price|default:'' }}">
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold text-muted mb-2">Memory (RAM)</label>
                        <div class="d-flex flex-wrap gap-2">
                            <label class="btn btn-outline-secondary btn-sm" style="font-size: 0.75rem;">
                                <input type="radio" name="ram" value="" class="d-none" checked> All
                            </label>
                            <label class="btn btn-outline-secondary btn-sm {% if selected_ram == '8GB' %}active{% endif %}" style="font-size: 0.75rem;">
                                <input type="radio" name="ram" value="8GB" class="d-none" {% if selected_ram == '8GB' %}checked{% endif %}> 8GB
                            </label>
                            <label class="btn btn-outline-secondary btn-sm {% if selected_ram == '16GB' %}active{% endif %}" style="font-size: 0.75rem;">
                                <input type="radio" name="ram" value="16GB" class="d-none" {% if selected_ram == '16GB' %}checked{% endif %}> 16GB
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                         <label class="small fw-bold text-muted mb-2">Design</label>
                         <select name="type" class="form-select form-select-sm bg-light border-0">
                             <option value="">Any Design</option>
                             <option value="X360" {% if selected_type == 'X360' %}selected{% endif %}>X360</option>
                             <option value="Slim" {% if selected_type == 'Slim' %}selected{% endif %}>Slim</option>
                             <option value="Detachable" {% if selected_type == 'Detachable' %}selected{% endif %}>Detachable</option>
                         </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="touchscreen" id="touch" {% if selected_touchscreen == 'on' %}checked{% endif %}>
                            <label class="form-check-label small" for="touch">Touchscreen</label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 btn-sm fw-bold">Apply Filters</button>
                </form>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Available Laptops</h5>
                <span class="text-muted small">{{ products.count }} items found</span>
            </div>
            
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
                {% for product in products %}
                <div class="col">
                    <div class="product-card">
                        <a href="{% url 'product_detail' product.id %}" class="card-img-container">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                            {% else %}
                            <div class="text-muted"><i class="fas fa-camera fa-2x"></i></div>
                            {% endif %}
                        </a>
                        
                        <div class="card-body">
                            <div class="product-category">{{ product.category.name }}</div>
                            <a href="{% url 'product_detail' product.id %}" class="product-title">
                                {{ product.name }}
                            </a>
                            
                            <div class="mb-2">
                                <span class="specs-badge">{{ product.ram }}</span>
                                {% if product.touchscreen %}
                                <span class="specs-badge text-success border-success"><i class="fas fa-fingerprint"></i> Touch</span>
                                {% endif %}
                            </div>

                            <div class="product-price">KES {{ product.price|intcomma }}</div>
                            
                            <a href="{% url 'product_detail' product.id %}" class="btn btn-view">View Details</a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <div class="py-5 bg-light rounded">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5>No laptops match your search</h5>
                        <p class="text-muted">Try removing some filters</p>
                        <a href="{% url 'index' %}" class="btn btn-outline-dark btn-sm">Clear All Filters</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

{% endblock %}